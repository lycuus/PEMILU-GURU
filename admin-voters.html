<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin OSSIP - Data Santri</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--dark-color);
        }

        /* ===== ADMIN DASHBOARD LAYOUT ===== */
        .admin-dashboard-container {
            display: flex;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* ===== SIDEBAR ===== */
        .admin-sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-color) 0%, #0d47a1 100%);
            color: white;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
        }

        .admin-profile {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 32px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .admin-profile h3 {
            font-size: 20px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .admin-role {
            color: #bbdefb;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .admin-username {
            color: #90caf9;
            font-size: 13px;
            font-weight: 500;
        }

        .admin-menu {
            flex: 1;
            margin-bottom: 20px;
        }

        .admin-menu ul {
            list-style: none;
        }

        .admin-menu li {
            margin-bottom: 8px;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .admin-menu li:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .admin-menu li.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #ffc107;
        }

        .admin-menu a {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            color: white;
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
        }

        .admin-menu i {
            width: 24px;
            margin-right: 12px;
            font-size: 16px;
            text-align: center;
        }

        .logout-section {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-logout {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* ===== MAIN CONTENT ===== */
        .admin-main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .page-header h1 {
            font-size: 28px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* ===== BUTTONS ===== */
        .btn-primary, .btn-secondary, .btn-danger {
            padding: 11px 22px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-secondary {
            background: var(--light-color);
            color: var(--gray-color);
            border: 1px solid #dee2e6;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(26, 35, 126, 0.3);
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger:hover {
            background: #c62828;
            transform: translateY(-2px);
        }

        /* ===== SUMMARY CARDS ===== */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 22px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 18px;
            font-size: 24px;
            color: white;
        }

        .card-icon.total {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .card-icon.voted {
            background: linear-gradient(135deg, var(--success-color) 0%, #2e7d32 100%);
        }

        .card-icon.not-voted {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ef6c00 100%);
        }

        .card-content h3 {
            font-size: 24px;
            margin-bottom: 4px;
            color: var(--dark-color);
            font-weight: 600;
        }

        .card-content p {
            color: var(--gray-color);
            font-size: 14px;
            font-weight: 500;
        }

        /* ===== SEARCH & FILTER ===== */
        .search-filter-section {
            background: white;
            padding: 22px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            border: 1px solid #f0f0f0;
        }

        .search-filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-control {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
            color: var(--dark-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .btn-filter {
            padding: 12px 22px;
            background: var(--info-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-filter:hover {
            background: #0d47a1;
            transform: translateY(-2px);
        }

        .search-box {
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-box input {
            padding-left: 45px;
        }

        /* ===== TABLE STYLES ===== */
        .voters-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            border: 1px solid #f0f0f0;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .voters-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .voters-table thead {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .voters-table th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
        }

        .voters-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }

        .voters-table tbody tr:hover {
            background: #f8f9fa;
        }

        .voters-table td {
            padding: 16px 15px;
            color: var(--dark-color);
            font-size: 14px;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .status-voted {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-not-voted {
            background: #fff3e0;
            color: #ef6c00;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 7px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn-edit {
            background: #f8f9fa;
            color: var(--gray-color);
            border: 1px solid #dee2e6;
        }

        .btn-edit:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: #ffebee;
            color: var(--danger-color);
            border: 1px solid #ffcdd2;
        }

        .btn-delete:hover {
            background: #ffcdd2;
            transform: translateY(-2px);
        }

        .btn-reset-vote {
            background: #e3f2fd;
            color: var(--info-color);
            border: 1px solid #bbdefb;
        }

        .btn-reset-vote:hover {
            background: #bbdefb;
            transform: translateY(-2px);
        }

        /* ===== PAGINATION ===== */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .pagination-info {
            color: var(--gray-color);
            font-size: 14px;
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 14px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            color: var(--dark-color);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* ===== FORM ROWS ===== */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* ===== BADGES ===== */
        .ossip-badge {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .class-badge {
            background: #e3f2fd;
            color: var(--info-color);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
        }

        .modal-title {
            font-size: 22px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: #90a4ae;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }

        .close-modal:hover {
            color: var(--danger-color);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eaeaea;
        }

        .modal-confirm .modal-content {
            max-width: 400px;
        }

        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }

        .loading-content {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .loading-content i {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: block;
        }

        .loading-content p {
            font-size: 16px;
            color: var(--dark-color);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .btn-retry {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-retry:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        /* ===== TOAST NOTIFICATION ===== */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark-color);
            color: white;
            padding: 15px 22px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 12px;
            animation: toastSlideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        .toast.warning {
            background: var(--warning-color);
        }

        .toast.info {
            background: var(--info-color);
        }

        .toast i {
            font-size: 18px;
        }

        /* ===== ERROR MESSAGE ===== */
        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .error-message i {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        .error-message h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        /* ===== FOOTER ===== */
        .admin-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
            text-align: center;
            color: var(--gray-color);
            font-size: 14px;
        }

        .admin-footer p {
            margin-bottom: 5px;
        }

        .admin-footer i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .admin-dashboard-container {
                flex-direction: column;
                margin: 10px;
            }
            
            .admin-sidebar {
                width: 100%;
                padding: 20px;
            }
            
            .search-filter-grid {
                grid-template-columns: 1fr 1fr auto;
            }
            
            .voters-table {
                min-width: 900px;
            }
        }

        @media (max-width: 992px) {
            .search-filter-grid {
                grid-template-columns: 1fr auto;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 768px) {
            .admin-main-content {
                padding: 20px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .search-filter-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .pagination-controls {
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .admin-dashboard-container {
                margin: 5px;
                border-radius: 10px;
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            .page-header h1 {
                font-size: 24px;
            }
        }

        /* ===== DEBUG INFO (Untuk Troubleshooting) ===== */
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Debug Info (Bisa diaktifkan untuk troubleshooting) -->
    <div class="debug-info" id="debugInfo">
        Status: Initializing...
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Memuat data santri...</p>
            <p id="loadingDetail" style="font-size: 14px; color: var(--gray-color);">Mohon tunggu</p>
            <button class="btn-retry" onclick="retryLoad()" style="display: none; margin-top: 15px;">
                <i class="fas fa-redo"></i> Coba Lagi
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toastMessage">Pesan</span>
    </div>

    <div class="admin-dashboard-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="admin-profile">
                <div class="profile-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h3 id="adminName">Memuat...</h3>
                <p class="admin-role" id="adminRole">Memuat...</p>
                <p class="admin-username" id="adminUsername">@memuat</p>
            </div>
            
            <nav class="admin-menu">
                <ul>
                    <li>
                        <a href="admin-dashboard.html">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="admin-voters.html">
                            <i class="fas fa-users"></i>
                            <span>Data Santri</span>
                        </a>
                    </li>
                    <li>
                        <a href="admin-statistics.html">
                            <i class="fas fa-chart-bar"></i>
                            <span>Statistik</span>
                        </a>
                    </li>
                    <li>
                        <a href="admin-logs.html">
                            <i class="fas fa-history"></i>
                            <span>Log Aktivitas</span>
                        </a>
                    </li>
                    <li>
                        <a href="admin-settings.html">
                            <i class="fas fa-cog"></i>
                            <span>Pengaturan</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="logout-section">
                <button class="btn-logout" onclick="doLogout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="admin-main-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-users"></i> Data Santri Pemilih <span class="ossip-badge">OSSIP</span></h1>
                <div class="header-actions">
                    <button class="btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i> Ekspor Data
                    </button>
                    <button class="btn-primary" onclick="showAddVoterModal()">
                        <i class="fas fa-plus"></i> Tambah Santri
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="card-icon total">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="card-content">
                        <h3 id="totalVoters">0</h3>
                        <p>Total Santri</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon voted">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="card-content">
                        <h3 id="votedCount">0</h3>
                        <p>Sudah Memilih</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon not-voted">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="card-content">
                        <h3 id="notVotedCount">0</h3>
                        <p>Belum Memilih</p>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="search-filter-section">
                <div class="search-filter-grid">
                    <div class="form-group">
                        <label for="searchInput"><i class="fas fa-search"></i> Cari Santri</label>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="Nama, username, atau kelas..." 
                                   oninput="handleSearchInput()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="statusFilter"><i class="fas fa-filter"></i> Status Voting</label>
                        <select id="statusFilter" class="form-control" onchange="filterVoters()">
                            <option value="all">Semua Status</option>
                            <option value="voted">Sudah Memilih</option>
                            <option value="not-voted">Belum Memilih</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="classFilter"><i class="fas fa-graduation-cap"></i> Kelas</label>
                        <select id="classFilter" class="form-control" onchange="filterVoters()">
                            <option value="all">Semua Kelas</option>
                            <option value="10B">Kelas 10B</option>
                            <option value="11C">Kelas 11C</option>
                            <option value="11D">Kelas 11D</option>
                            <option value="12C">Kelas 12C</option>
                            <option value="12D">Kelas 12D</option>
                        </select>
                    </div>
                    <button class="btn-filter" onclick="resetFilters()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Voters Table -->
            <div class="voters-table-container">
                <div class="table-responsive">
                    <table class="voters-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Santri</th>
                                <th>Username</th>
                                <th>Kelas</th>
                                <th>Status</th>
                                <th>Waktu Voting</th>
                                <th>Pilihan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="votersTableBody">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info" id="paginationInfo">
                    Menampilkan 0-0 dari 0 santri
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="changePage(currentPage - 1)" disabled id="prevBtn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div id="pageNumbers"></div>
                    <button class="pagination-btn" onclick="changePage(currentPage + 1)" disabled id="nextBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <div class="admin-footer">
                <p>&copy; 2024 Organisasi Siswa Santri (OSSIP). Hak Cipta Dilindungi.</p>
                <p><i class="fas fa-mosque"></i> Pondok Pesantren Darussalam</p>
            </div>
        </div>
    </div>

    <!-- Modal Tambah/Edit Santri -->
    <div id="voterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">
                    <i class="fas fa-user-plus"></i> Tambah Santri Baru
                </h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="voterForm">
                    <div class="form-group">
                        <label for="fullName">Nama Lengkap Santri *</label>
                        <input type="text" id="fullName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="username">Username *</label>
                        <input type="text" id="username" class="form-control" required 
                               pattern="[a-zA-Z0-9]+" title="Hanya huruf dan angka">
                        <small style="color: var(--gray-color); font-size: 12px; margin-top: 5px; display: block;">
                            Contoh: siswa108
                        </small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="kelas">Kelas *</label>
                            <select id="kelas" class="form-control" required>
                                <option value="">Pilih Kelas</option>
                                <option value="10B">Kelas 10B</option>
                                <option value="11C">Kelas 11C</option>
                                <option value="11D">Kelas 11D</option>
                                <option value="12C">Kelas 12C</option>
                                <option value="12D">Kelas 12D</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status">Status Voting</label>
                            <select id="status" class="form-control">
                                <option value="false">Belum Memilih</option>
                                <option value="true">Sudah Memilih</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="candidateField" style="display: none;">
                        <label for="candidateId">Pilihan Kandidat *</label>
                        <select id="candidateId" class="form-control">
                            <option value="">Pilih Kandidat</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal()">
                            Batal
                        </button>
                        <button type="submit" class="btn-primary" id="submitBtn">
                            Simpan Data
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi -->
    <div id="confirmModal" class="modal modal-confirm">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Konfirmasi
                </h3>
                <button class="close-modal" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Apakah Anda yakin?</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeConfirmModal()">
                    Batal
                </button>
                <button type="button" class="btn-danger" id="confirmActionBtn">
                    Ya, Lanjutkan
                </button>
            </div>
        </div>
    </div>
    <script src="database.js"></script>
    <script>
        // ===== GLOBAL VARIABLES =====
        let allVoters = [];
        let filteredVoters = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let isEditing = false;
        let editingVoterId = null;
        let candidates = [];
        let searchTimer = null;

        // ===== DEBUG UTILITIES =====
        function debugLog(message) {
            console.log(`[Admin Voters] ${message}`);
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.textContent = message;
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('DOM Content Loaded');
            
            // Check session first
            checkSession();
            
            // Set admin info
            setAdminInfo();
            
            // Initialize the page
            await initializePage();
            
            // Set up event listeners
            setupEventListeners();
        });

        // Check session
        function checkSession() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            const adminUsername = sessionStorage.getItem('adminUsername');
            
            if (!isLoggedIn || !adminUsername) {
                showToast('Anda harus login sebagai admin terlebih dahulu!', 'warning');
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 2000);
                return false;
            }
            return true;
        }

        // Set admin info
        function setAdminInfo() {
            try {
                const adminName = sessionStorage.getItem('adminName') || 'Admin Panitia';
                const adminRole = sessionStorage.getItem('adminRole') || 'Super Admin';
                const adminUsername = sessionStorage.getItem('adminUsername') || 'admin';
                
                document.getElementById('adminName').textContent = adminName;
                document.getElementById('adminRole').textContent = adminRole;
                document.getElementById('adminUsername').textContent = '@' + adminUsername;
                
                debugLog(`Admin Info: ${adminName} (${adminRole})`);
            } catch (error) {
                console.error('Error setting admin info:', error);
            }
        }

        // Initialize page
        async function initializePage() {
            debugLog('Initializing page...');
            showLoading('Memuat data santri...');
            
            try {
                // Wait for database to be ready
                await waitForDatabase();
                
                // Load initial data
                await loadInitialData();
                
                debugLog('Page initialized successfully');
                
            } catch (error) {
                debugLog(`Initialization failed: ${error.message}`);
                showToast('Gagal memuat data: ' + error.message, 'error');
                showFallbackUI();
            } finally {
                showLoading(false);
            }
        }

        // Wait for database
   async function waitForDatabase() {
    debugLog('Waiting for database...');
    
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 30; // Tambah waktu tunggu
        
        const checkDatabase = () => {
            attempts++;
            document.getElementById('loadingDetail').textContent = 
                `Mengecek database... (${attempts}/${maxAttempts})`;
            
            // Cek lebih spesifik
            if (window.db && typeof window.db.getAllVoters === 'function') {
                debugLog('Database ready!');
                resolve();
                return;
            }
            
            if (attempts >= maxAttempts) {
                debugLog(`Database timeout. window.db = ${window.db ? 'exists' : 'null'}`);
                reject(new Error('Database tidak ditemukan. Pastikan database.js dimuat.'));
                return;
            }
            
            setTimeout(checkDatabase, 500);
        };
        
        checkDatabase();
    });
}

        // Load initial data
        async function loadInitialData() {
            debugLog('Loading initial data...');
            document.getElementById('loadingDetail').textContent = 'Memuat data santri...';
            
            try {
                // Load voters
                allVoters = await window.db.getAllVoters();
                debugLog(`Loaded ${allVoters.length} voters`);
                
                // Load candidates
                candidates = await window.db.getAllCandidates();
                debugLog(`Loaded ${candidates.length} candidates`);
                
                // Update summary
                updateSummary();
                
                // Initialize table
                filteredVoters = [...allVoters];
                renderVotersTable();
                
                // Show success message
                if (allVoters.length > 0) {
                    showToast(`Berhasil memuat ${allVoters.length} data santri`, 'success');
                }
                
            } catch (error) {
                debugLog(`Error loading data: ${error.message}`);
                throw error;
            }
        }

        // ===== UI FUNCTIONS =====
        
        // Show loading overlay
        function showLoading(message = 'Memuat...') {
            const overlay = document.getElementById('loadingOverlay');
            const retryBtn = overlay.querySelector('.btn-retry');
            
            if (message) {
                overlay.style.display = 'flex';
                document.getElementById('loadingDetail').textContent = message;
                retryBtn.style.display = 'none';
            } else {
                overlay.style.display = 'none';
            }
        }

        // Show retry button
        function showRetryButton() {
            const retryBtn = document.querySelector('.btn-retry');
            if (retryBtn) {
                retryBtn.style.display = 'inline-flex';
            }
        }

        // Retry loading
        function retryLoad() {
            debugLog('Retrying load...');
            initializePage();
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'flex';
            
            // Set icon based on type
            const icon = toast.querySelector('i');
            switch(type) {
                case 'success':
                    icon.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle';
                    break;
                default:
                    icon.className = 'fas fa-info-circle';
            }
            
            // Auto hide
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Update summary cards
        function updateSummary() {
            const totalVoters = allVoters.length;
            const votedCount = allVoters.filter(v => v.has_voted).length;
            const notVotedCount = totalVoters - votedCount;
            
            document.getElementById('totalVoters').textContent = totalVoters;
            document.getElementById('votedCount').textContent = votedCount;
            document.getElementById('notVotedCount').textContent = notVotedCount;
        }

        // ===== TABLE FUNCTIONS =====
        
        // Render voters table
        function renderVotersTable() {
            const tableBody = document.getElementById('votersTableBody');
            
            if (filteredVoters.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <i class="fas fa-users-slash" style="font-size: 48px; color: #bdbdbd; margin-bottom: 15px;"></i>
                            <p style="color: #757575; font-size: 16px; margin-bottom: 10px;">Tidak ada data santri yang ditemukan</p>
                            <button onclick="resetFilters()" class="btn-secondary" style="margin-top: 10px;">
                                <i class="fas fa-redo"></i> Reset Filter
                            </button>
                        </td>
                    </tr>
                `;
                updatePagination();
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredVoters.length);
            const pageVoters = filteredVoters.slice(startIndex, endIndex);
            
            let tableHTML = '';
            
            pageVoters.forEach((voter, index) => {
                const rowNumber = startIndex + index + 1;
                const statusClass = voter.has_voted ? 'status-voted' : 'status-not-voted';
                const statusText = voter.has_voted ? 'Sudah Memilih' : 'Belum Memilih';
                const voteTime = voter.has_voted && voter.vote_time 
                    ? formatDateTime(voter.vote_time) 
                    : '-';
                
                // Get candidate info if voted
                let candidateInfo = '-';
                if (voter.has_voted && voter.vote_candidate_id) {
                    const candidate = candidates.find(c => c.id === voter.vote_candidate_id);
                    if (candidate) {
                        candidateInfo = `No. ${candidate.number} - ${candidate.chairman_name}`;
                    }
                }
                
                tableHTML += `
                    <tr>
                        <td>${rowNumber}</td>
                        <td>
                            <strong>${voter.name}</strong>
                            ${voter.has_voted ? 
                                '<span class="ossip-badge"><i class="fas fa-vote-yea"></i> Telah Voting</span>' : 
                                ''}
                        </td>
                        <td><code>${voter.username}</code></td>
                        <td>
                            <span class="class-badge">${voter.class}</span>
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${voteTime}</td>
                        <td>${candidateInfo}</td>
                        <td>
                            <div class="action-buttons">
                                ${voter.has_voted ? `
                                    <button class="btn-action btn-reset-vote" onclick="resetSingleVote(${voter.id})" 
                                            title="Reset Voting" data-id="${voter.id}">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                ` : ''}
                                <button class="btn-action btn-edit" onclick="editVoter(${voter.id})" 
                                        title="Edit Data" data-id="${voter.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn-action btn-delete" onclick="deleteVoter(${voter.id})" 
                                        title="Hapus Data" data-id="${voter.id}">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            updatePagination();
        }

        // Format date time
        function formatDateTime(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredVoters.length / itemsPerPage);
            
            // Update pagination info
            const startItem = filteredVoters.length > 0 ? ((currentPage - 1) * itemsPerPage + 1) : 0;
            const endItem = Math.min(currentPage * itemsPerPage, filteredVoters.length);
            document.getElementById('paginationInfo').textContent = 
                `Menampilkan ${startItem}-${endItem} dari ${filteredVoters.length} santri`;
            
            // Update buttons
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            
            // Update page numbers
            const pageNumbersDiv = document.getElementById('pageNumbers');
            pageNumbersDiv.innerHTML = '';
            
            // Show limited page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.onclick = () => changePage(i);
                pageNumbersDiv.appendChild(btn);
            }
        }

        // Change page
        function changePage(page) {
            if (page < 1 || page > Math.ceil(filteredVoters.length / itemsPerPage)) {
                return;
            }
            
            currentPage = page;
            renderVotersTable();
            
            // Smooth scroll to top of table
            const tableContainer = document.querySelector('.voters-table-container');
            if (tableContainer) {
                tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ===== FILTER FUNCTIONS =====
        
        // Handle search input with debounce
        function handleSearchInput() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                filterVoters();
            }, 300);
        }

        // Filter voters
        function filterVoters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const classFilter = document.getElementById('classFilter').value;
            
            filteredVoters = allVoters.filter(voter => {
                // Search filter
                const matchesSearch = searchTerm === '' || 
                    voter.name.toLowerCase().includes(searchTerm) ||
                    voter.username.toLowerCase().includes(searchTerm) ||
                    voter.class.toLowerCase().includes(searchTerm);
                
                // Status filter
                let matchesStatus = true;
                if (statusFilter === 'voted') {
                    matchesStatus = voter.has_voted === true;
                } else if (statusFilter === 'not-voted') {
                    matchesStatus = voter.has_voted === false;
                }
                
                // Class filter
                const matchesClass = classFilter === 'all' || voter.class === classFilter;
                
                return matchesSearch && matchesStatus && matchesClass;
            });
            
            currentPage = 1;
            renderVotersTable();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('classFilter').value = 'all';
            filterVoters();
            showToast('Filter telah direset', 'info');
        }

        // ===== MODAL FUNCTIONS =====
        
        // Show add voter modal
        async function showAddVoterModal() {
            debugLog('Showing add voter modal');
            
            isEditing = false;
            editingVoterId = null;
            
            document.getElementById('modalTitle').innerHTML = 
                '<i class="fas fa-user-plus"></i> Tambah Santri Baru';
            document.getElementById('voterForm').reset();
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Simpan Data';
            
            // Populate candidate dropdown
            const candidateSelect = document.getElementById('candidateId');
            candidateSelect.innerHTML = '<option value="">Pilih Kandidat</option>';
            candidates.forEach(candidate => {
                candidateSelect.innerHTML += `
                    <option value="${candidate.id}">
                        No. ${candidate.number} - ${candidate.chairman_name}
                    </option>
                `;
            });
            
            // Show/hide candidate field based on status
            const statusSelect = document.getElementById('status');
            statusSelect.onchange = function() {
                document.getElementById('candidateField').style.display = 
                    this.value === 'true' ? 'block' : 'none';
            };
            
            document.getElementById('voterModal').style.display = 'flex';
        }

        // Edit voter
        async function editVoter(voterId) {
            debugLog(`Editing voter ${voterId}`);
            showLoading('Memuat data santri...');
            
            try {
                const voter = await window.db.getVoterById(voterId);
                
                if (!voter) {
                    showToast('Data santri tidak ditemukan', 'error');
                    return;
                }
                
                isEditing = true;
                editingVoterId = voterId;
                
                document.getElementById('modalTitle').innerHTML = 
                    '<i class="fas fa-edit"></i> Edit Data Santri';
                document.getElementById('fullName').value = voter.name;
                document.getElementById('username').value = voter.username;
                document.getElementById('kelas').value = voter.class;
                document.getElementById('status').value = voter.has_voted.toString();
                
                // Populate candidate dropdown
                const candidateSelect = document.getElementById('candidateId');
                candidateSelect.innerHTML = '<option value="">Pilih Kandidat</option>';
                candidates.forEach(candidate => {
                    candidateSelect.innerHTML += `
                        <option value="${candidate.id}" ${voter.vote_candidate_id === candidate.id ? 'selected' : ''}>
                            No. ${candidate.number} - ${candidate.chairman_name}
                        </option>
                    `;
                });
                
                // Show/hide candidate field
                document.getElementById('candidateField').style.display = 
                    voter.has_voted ? 'block' : 'none';
                
                // Status change handler
                const statusSelect = document.getElementById('status');
                statusSelect.onchange = function() {
                    document.getElementById('candidateField').style.display = 
                        this.value === 'true' ? 'block' : 'none';
                };
                
                document.getElementById('submitBtn').innerHTML = '<i class="fas fa-sync"></i> Update Data';
                document.getElementById('voterModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error editing voter:', error);
                showToast('Gagal memuat data santri', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('voterModal').style.display = 'none';
        }

        // Close confirm modal
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // ===== VOTER OPERATIONS =====
        
        // Delete voter
        async function deleteVoter(voterId) {
            const voter = allVoters.find(v => v.id === voterId);
            if (!voter) return;
            
            debugLog(`Deleting voter ${voterId}: ${voter.name}`);
            
            document.getElementById('confirmMessage').textContent = 
                `Apakah Anda yakin ingin menghapus data santri "${voter.name}" (${voter.username})?`;
            
            document.getElementById('confirmActionBtn').onclick = async () => {
                debugLog(`Confirming deletion of voter ${voterId}`);
                showLoading('Menghapus data santri...');
                
                try {
                    await window.db.deleteVoter(voterId);
                    
                    // Remove from local arrays
                    allVoters = allVoters.filter(v => v.id !== voterId);
                    filteredVoters = filteredVoters.filter(v => v.id !== voterId);
                    
                    // Update UI
                    updateSummary();
                    renderVotersTable();
                    
                    showToast('Data santri berhasil dihapus', 'success');
                    closeConfirmModal();
                    
                } catch (error) {
                    console.error('Error deleting voter:', error);
                    showToast('Gagal menghapus data santri', 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            document.getElementById('confirmModal').style.display = 'flex';
        }

        // Reset single vote
        async function resetSingleVote(voterId) {
            const voter = allVoters.find(v => v.id === voterId);
            if (!voter || !voter.has_voted) return;
            
            debugLog(`Resetting vote for voter ${voterId}: ${voter.name}`);
            
            document.getElementById('confirmMessage').textContent = 
                `Apakah Anda yakin ingin mereset voting untuk "${voter.name}"?`;
            
            document.getElementById('confirmActionBtn').onclick = async () => {
                debugLog(`Confirming vote reset for voter ${voterId}`);
                showLoading('Mereset voting...');
                
                try {
                    await window.db.resetSingleVote(voterId);
                    
                    // Refresh data
                    await loadInitialData();
                    
                    showToast('Voting berhasil direset', 'success');
                    closeConfirmModal();
                    
                } catch (error) {
                    console.error('Error resetting vote:', error);
                    showToast('Gagal mereset voting', 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            document.getElementById('confirmModal').style.display = 'flex';
        }

        // Export data
        async function exportData() {
            debugLog('Exporting data...');
            showLoading('Menyiapkan data untuk diekspor...');
            
            try {
                if (window.db.exportVotingDataToCSV) {
                    await window.db.exportVotingDataToCSV();
                    showToast('Data berhasil diekspor', 'success');
                } else {
                    showToast('Fitur ekspor tidak tersedia', 'error');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('Gagal mengekspor data', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ===== FORM HANDLING =====
        
        // Form submission
        document.getElementById('voterForm').onsubmit = async function(e) {
            e.preventDefault();
            
            debugLog('Submitting voter form...');
            
            const formData = {
                name: document.getElementById('fullName').value.trim(),
                username: document.getElementById('username').value.trim(),
                class: document.getElementById('kelas').value,
                has_voted: document.getElementById('status').value === 'true'
            };
            
            // Validate form
            if (!formData.name || !formData.username || !formData.class) {
                showToast('Harap isi semua field yang wajib diisi', 'warning');
                return;
            }
            
            // Validate username format
            if (!/^[a-zA-Z0-9]+$/.test(formData.username)) {
                showToast('Username hanya boleh mengandung huruf dan angka', 'warning');
                return;
            }
            
            // If voted, get candidate ID
            if (formData.has_voted) {
                const candidateId = document.getElementById('candidateId').value;
                if (!candidateId) {
                    showToast('Harap pilih kandidat jika status sudah memilih', 'warning');
                    return;
                }
                formData.vote_candidate_id = parseInt(candidateId);
                formData.vote_time = new Date().toISOString();
            } else {
                formData.vote_candidate_id = null;
                formData.vote_time = null;
            }
            
            showLoading(isEditing ? 'Memperbarui data...' : 'Menyimpan data...');
            
            try {
                if (isEditing && editingVoterId) {
                    // Update existing voter
                    await window.db.updateVoter(editingVoterId, formData);
                    showToast('Data santri berhasil diperbarui', 'success');
                } else {
                    // Add new voter - need to generate new ID
                    const existingIds = allVoters.map(v => v.id);
                    const newId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
                    
                    // Check if username already exists
                    const usernameExists = allVoters.some(v => v.username === formData.username);
                    if (usernameExists) {
                        throw new Error('Username sudah digunakan');
                    }
                    
                    await window.db.addVoter({
                        id: newId,
                        ...formData
                    });
                    showToast('Data santri berhasil ditambahkan', 'success');
                }
                
                // Refresh data
                await loadInitialData();
                
                // Close modal
                closeModal();
                
            } catch (error) {
                console.error('Error saving voter:', error);
                showToast('Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };

        // ===== FALLBACK UI =====
        
        // Show fallback UI if database fails
       function showFallbackUI() {
    const tableBody = document.getElementById('votersTableBody');
    tableBody.innerHTML = `
        <tr>
            <td colspan="8" style="text-align: center; padding: 40px;">
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Gagal Memuat Data</h3>
                    <p>Terjadi kesalahan saat memuat data dari database.</p>
                    <p id="errorDetail" style="font-size: 12px; margin-top: 10px; color: #666;">
                        Error: Database tidak ditemukan
                    </p>
                    <div style="margin-top: 20px;">
                        <button onclick="retryLoad()" class="btn-primary">
                            <i class="fas fa-redo"></i> Coba Lagi
                        </button>
                        <button onclick="checkDatabaseStatus()" class="btn-secondary" style="margin-left: 10px;">
                            <i class="fas fa-bug"></i> Debug Database
                        </button>
                    </div>
                </div>
            </td>
        </tr>
    `;
    
    showRetryButton();
}

// Tambahkan fungsi untuk debug
function checkDatabaseStatus() {
    console.log('=== DATABASE DEBUG INFO ===');
    console.log('window.db exists?', !!window.db);
    console.log('window.db type:', typeof window.db);
    if (window.db) {
        console.log('Database methods:', Object.keys(window.db));
    }
    console.log('=== END DEBUG INFO ===');
    
    showToast('Info database telah dicatat di console', 'info');
}
            
            // Show retry button in loading overlay
            showRetryButton();

        // ===== EVENT LISTENERS =====
        
        function setupEventListeners() {
            debugLog('Setting up event listeners...');
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('voterModal');
                const confirmModal = document.getElementById('confirmModal');
                
                if (event.target === modal) {
                    closeModal();
                }
                if (event.target === confirmModal) {
                    closeConfirmModal();
                }
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                    closeConfirmModal();
                }
            });
            
            // Status change listener for candidate field
            document.getElementById('status')?.addEventListener('change', function() {
                document.getElementById('candidateField').style.display = 
                    this.value === 'true' ? 'block' : 'none';
            });
            
            debugLog('Event listeners set up');
        }

        // ===== LOGOUT =====
        
        function doLogout() {
            debugLog('Logging out...');
            
            document.getElementById('confirmMessage').textContent = 
                'Apakah Anda yakin ingin logout?';
            
            document.getElementById('confirmActionBtn').onclick = function() {
                debugLog('Confirming logout');
                sessionStorage.clear();
                localStorage.clear();
                window.location.href = 'admin-login.html';
            };
            
            document.getElementById('confirmModal').style.display = 'flex';
        }

        // ===== INITIAL DEBUG CHECK =====
        console.log('Admin Voters Page Script Loaded');
        console.log('Checking database availability...');
        
        // Quick database check
        setTimeout(() => {
            if (window.db) {
                console.log(' Database object found:', window.db.constructor.name);
                console.log('Available methods:', Object.keys(window.db).filter(key => typeof window.db[key] === 'function'));
            } else {
                console.log(' Database object not found in window.db');
                console.log('Trying to load database.js manually...');
                
                // Try to load database.js if not loaded
                if (!document.querySelector('script[src*="database.js"]')) {
                    const script = document.createElement('script');
                    script.src = 'database.js';
                    script.onload = () => {
                        console.log(' database.js loaded manually');
                        retryLoad();
                    };
                    script.onerror = () => {
                        console.log(' Failed to load database.js');
                        showFallbackUI();
                    };
                    document.head.appendChild(script);
                }
            }
        }, 1000);
    </script>
</body>
</html>