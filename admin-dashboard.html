<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - OSSIP 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #f5f7fa; color: #333; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .admin-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-refresh { background: #3498db; color: white; }
        .btn-reset { background: #e74c3c; color: white; }
        .btn-export { background: #2ecc71; color: white; }
        
        .btn-refresh:hover { background: #2980b9; }
        .btn-reset:hover { background: #c0392b; }
        .btn-export:hover { background: #27ae60; }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 { color: #2c3e50; margin-bottom: 10px; }
        .stat-value { font-size: 36px; font-weight: 700; color: #3498db; }
        .stat-label { color: #7f8c8d; font-size: 14px; }
        
        .results-section { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #2c3e50; font-weight: 600; }
        tr:hover { background: #f5f9ff; }
        
        .vote-timeline { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .vote-item { 
            padding: 15px; 
            border-left: 3px solid #3498db; 
            margin-bottom: 10px; 
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .realtime-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #27ae60;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .progress-bar {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            transition: width 0.5s ease;
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #e74c3c;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-cancel {
            background: #95a5a6;
            color: white;
        }
        
        .btn-confirm {
            background: #e74c3c;
            color: white;
        }
        
        .btn-cancel:hover { background: #7f8c8d; }
        .btn-confirm:hover { background: #c0392b; }
        
        /* Notification Styles */
        .vote-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
            border-left: 4px solid #27ae60;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1><i class="fas fa-chart-line"></i> ADMIN DASHBOARD</h1>
                <p>OSSIP 2026-2027 | Real-time Voting Monitor</p>
            </div>
        </div>
        
        <!-- Admin Controls -->
        <div class="admin-controls">
            <button id="refreshBtn" class="btn-refresh">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
            <button id="resetBtn" class="btn-reset">
                <i class="fas fa-trash-alt"></i> Reset Semua Vote
            </button>
            <button id="exportBtn" class="btn-export">
                <i class="fas fa-download"></i> Export Data
            </button>
        </div>
        
        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3><i class="fas fa-users"></i> Total Pemilih</h3>
                <div class="stat-value" id="totalVoters">0</div>
                <div class="stat-label">Jumlah yang sudah memilih</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-male"></i> Ikhwan Votes</h3>
                <div class="stat-value" id="ikhwanVotes">0</div>
                <div class="stat-label">Total suara kandidat ikhwan</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-female"></i> Akhwat Votes</h3>
                <div class="stat-value" id="akhwatVotes">0</div>
                <div class="stat-label">Total suara kandidat akhwat</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-clock"></i> Real-time</h3>
                <div class="stat-value"><span class="realtime-indicator"></span> LIVE</div>
                <div class="stat-label" id="lastUpdate">Memperbarui...</div>
            </div>
        </div>
        
        <!-- Results Table -->
        <div class="results-section">
            <h2><i class="fas fa-trophy"></i> Hasil Voting Real-time</h2>
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Nama Kandidat</th>
                            <th>Kelas</th>
                            <th>Gender</th>
                            <th>Jumlah Suara</th>
                            <th>Persentase</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Vote Timeline -->
        <div class="vote-timeline">
            <h2><i class="fas fa-history"></i> Timeline Voting Terakhir</h2>
            <div id="voteTimeline">
                <!-- Timeline akan diisi oleh JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Reset Confirmation Modal -->
    <div id="resetModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Konfirmasi Reset</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>PERHATIAN:</strong> Anda akan menghapus SEMUA data voting!</p>
                <ul style="margin: 15px 0; padding-left: 20px; color: #e74c3c;">
                    <li>Semua suara akan dihapus</li>
                    <li>Data pemilih akan direset</li>
                    <li>Timeline voting akan dikosongkan</li>
                    <li>Aksi ini TIDAK dapat dibatalkan</li>
                </ul>
                <p>Masukkan password admin untuk melanjutkan:</p>
                <input type="password" id="adminPassword" placeholder="Password Admin" 
                       style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;margin-top:10px;">
                <p id="passwordError" style="color:#e74c3c;font-size:12px;margin-top:5px;display:none;">
                    <i class="fas fa-exclamation-circle"></i> Password salah!
                </p>
            </div>
            <div class="modal-footer">
                <button id="cancelReset" class="btn-cancel">Batal</button>
                <button id="confirmReset" class="btn-confirm">Reset Semua Data</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div id="exportModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-download"></i> Export Data</h3>
                <button class="close-export-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Pilih format untuk export data voting:</p>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button id="exportJSON" class="btn-export" style="flex:1;">
                        <i class="fas fa-code"></i> JSON
                    </button>
                    <button id="exportCSV" class="btn-export" style="flex:1;">
                        <i class="fas fa-table"></i> CSV
                    </button>
                    <button id="exportPDF" class="btn-export" style="flex:1;">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // ADMIN DASHBOARD SCRIPT DENGAN FITUR RESET
    // ============================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log("ðŸ“Š Admin Dashboard started");
        
        let lastVoteTimestamp = 0;
        let pollingInterval;
        const ADMIN_PASSWORD = "admin123"; // Password admin default
        
        // ============================================
        // 1. INITIALIZE DASHBOARD
        // ============================================
        async function initializeDashboard() {
            console.log("ðŸš€ Initializing admin dashboard...");
            
            // Load data pertama kali
            await loadVotingData();
            
            // Mulai real-time polling
            startRealTimePolling();
            
            // Set initial timestamp
            lastVoteTimestamp = parseInt(localStorage.getItem('last_vote_timestamp') || '0');
            
            console.log("âœ… Admin dashboard ready");
        }
        
        // ============================================
        // 2. LOAD VOTING DATA
        // ============================================
        async function loadVotingData() {
            console.log("ðŸ”„ Loading voting data...");
            
            try {
                let candidates = [];
                let votes = [];
                
                // Coba dapatkan dari database
                if (window.db && window.db.getAllCandidates && window.db.getAllVotes) {
                    try {
                        candidates = await window.db.getAllCandidates();
                        votes = await window.db.getAllVotes();
                        console.log("ðŸ“Š Data from database - Candidates:", candidates.length, "Votes:", votes.length);
                    } catch (dbError) {
                        console.log("âš ï¸ Database error, using localStorage:", dbError.message);
                    }
                }
                
                // Fallback ke localStorage jika database kosong atau error
                if (candidates.length === 0) {
                    candidates = JSON.parse(localStorage.getItem('candidates') || '[]');
                    
                    if (candidates.length === 0) {
                        // Buat kandidat default dengan votes 0
                        candidates = [
                            { id: 1, number: 1, gender: 'ikhwan', chairman_name: "MUHAMAD FADLAN ARFANI", chairman_class: "XI C", votes: 0 },
                            { id: 2, number: 2, gender: 'ikhwan', chairman_name: "PRAMUDITA AULADI", chairman_class: "XI C", votes: 0 },
                            { id: 3, number: 3, gender: 'ikhwan', chairman_name: "DARMA ALIF SAPUTRA", chairman_class: "XI D", votes: 0 },
                            { id: 4, number: 1, gender: 'akhwat', chairman_name: "AMRELINA", chairman_class: "XI B", votes: 0 },
                            { id: 5, number: 2, gender: 'akhwat', chairman_name: "KHOLIDAH IZZATI", chairman_class: "XI B", votes: 0 },
                            { id: 6, number: 3, gender: 'akhwat', chairman_name: "NAVA AISILA HASNA", chairman_class: "XI B", votes: 0 }
                        ];
                        
                        // Simpan kandidat ke localStorage
                        localStorage.setItem('candidates', JSON.stringify(candidates));
                    }
                }
                
                if (votes.length === 0) {
                    votes = JSON.parse(localStorage.getItem('admin_votes') || '[]');
                }
                
                // Update vote counts
                candidates.forEach(candidate => {
                    const candidateVotes = votes.filter(vote => 
                        vote.ikhwan_candidate_id === candidate.id || 
                        vote.akhwat_candidate_id === candidate.id
                    ).length;
                    
                    candidate.votes = Math.max(candidate.votes || 0, candidateVotes);
                });
                
                // Update UI
                updateStatistics(candidates, votes);
                updateResultsTable(candidates);
                updateVoteTimeline(votes);
                
                // Update timestamp
                document.getElementById('lastUpdate').textContent = 
                    `Terakhir update: ${new Date().toLocaleTimeString('id-ID')}`;
                    
            } catch (error) {
                console.error("âŒ Error loading voting data:", error);
            }
        }
        
        // ============================================
        // 3. UPDATE STATISTICS
        // ============================================
        function updateStatistics(candidates, votes) {
            // Total pemilih
            const totalVoters = votes.length || 0;
            document.getElementById('totalVoters').textContent = totalVoters;
            
            // Total votes ikhwan & akhwat
            const ikhwanCandidates = candidates.filter(c => c.gender === 'ikhwan');
            const akhwatCandidates = candidates.filter(c => c.gender === 'akhwat');
            
            const ikhwanVotes = ikhwanCandidates.reduce((sum, c) => sum + (c.votes || 0), 0);
            const akhwatVotes = akhwatCandidates.reduce((sum, c) => sum + (c.votes || 0), 0);
            
            document.getElementById('ikhwanVotes').textContent = ikhwanVotes;
            document.getElementById('akhwatVotes').textContent = akhwatVotes;
        }
        
        // ============================================
        // 4. UPDATE RESULTS TABLE
        // ============================================
        function updateResultsTable(candidates) {
            const tbody = document.querySelector('#resultsTable tbody');
            if (!tbody) return;
            
            // Urutkan berdasarkan jumlah vote terbanyak
            candidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));
            
            // Hitung total votes untuk persentase
            const totalVotes = candidates.reduce((sum, c) => sum + (c.votes || 0), 0);
            
            tbody.innerHTML = candidates.map(candidate => {
                const percentage = totalVotes > 0 ? ((candidate.votes || 0) / totalVotes * 100).toFixed(1) : 0;
                
                return `
                    <tr>
                        <td>${candidate.number}</td>
                        <td><strong>${candidate.chairman_name}</strong></td>
                        <td>${candidate.chairman_class}</td>
                        <td><span class="gender-badge" style="background:${candidate.gender === 'ikhwan' ? '#3498db' : '#e91e63'};color:white;padding:4px 8px;border-radius:12px;font-size:12px;">
                            ${candidate.gender === 'ikhwan' ? 'Ikhwan' : 'Akhwat'}
                        </span></td>
                        <td>${candidate.votes || 0}</td>
                        <td>
                            <div>${percentage}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ============================================
        // 5. UPDATE VOTE TIMELINE
        // ============================================
        function updateVoteTimeline(votes) {
            const timeline = document.getElementById('voteTimeline');
            if (!timeline) return;
            
            // Ambil 10 vote terbaru
            const recentVotes = votes.slice(-10).reverse();
            
            if (recentVotes.length === 0) {
                timeline.innerHTML = '<p style="text-align:center;color:#7f8c8d;padding:20px;">Belum ada data voting</p>';
                return;
            }
            
            timeline.innerHTML = recentVotes.map(vote => {
                const time = new Date(vote.timestamp || Date.now()).toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                return `
                    <div class="vote-item">
                        <div>
                            <strong>${vote.voter_name || 'Anonim'}</strong> (${vote.voter_class || 'Tidak diketahui'})
                            <div style="color:#666;font-size:12px;margin-top:4px;">
                                <i class="fas fa-clock"></i> ${time}
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#3498db;font-weight:600;">
                                <i class="fas fa-male"></i> Kandidat Ikhwan
                            </div>
                            <div style="color:#e91e63;font-weight:600;">
                                <i class="fas fa-female"></i> Kandidat Akhwat
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ============================================
        // 6. RESET ALL VOTES FUNCTION
        // ============================================
        async function resetAllVotes() {
            console.log("ðŸ”„ Resetting all votes...");
            
            const passwordInput = document.getElementById('adminPassword');
            const passwordError = document.getElementById('passwordError');
            const password = passwordInput.value.trim();
            
            // Validasi password
            if (password !== ADMIN_PASSWORD) {
                passwordError.style.display = 'block';
                passwordInput.style.borderColor = '#e74c3c';
                passwordInput.focus();
                return;
            }
            
            try {
                // Reset di database (jika ada)
                if (window.db && window.db.resetAllVotes) {
                    await window.db.resetAllVotes();
                    console.log("âœ… Database votes reset");
                }
                
                // Reset di localStorage
                localStorage.removeItem('votes');
                localStorage.removeItem('admin_votes');
                localStorage.removeItem('vote_count');
                localStorage.removeItem('last_vote_timestamp');
                localStorage.removeItem('vote_update_trigger');
                
                // Reset candidates votes to 0
                let candidates = JSON.parse(localStorage.getItem('candidates') || '[]');
                if (candidates.length === 0) {
                    candidates = [
                        { id: 1, number: 1, gender: 'ikhwan', chairman_name: "MUHAMAD FADLAN ARFANI", chairman_class: "XI C", votes: 0 },
                        { id: 2, number: 2, gender: 'ikhwan', chairman_name: "PRAMUDITA AULADI", chairman_class: "XI C", votes: 0 },
                        { id: 3, number: 3, gender: 'ikhwan', chairman_name: "DARMA ALIF SAPUTRA", chairman_class: "XI D", votes: 0 },
                        { id: 4, number: 1, gender: 'akhwat', chairman_name: "AMRELINA", chairman_class: "XI B", votes: 0 },
                        { id: 5, number: 2, gender: 'akhwat', chairman_name: "KHOLIDAH IZZATI", chairman_class: "XI B", votes: 0 },
                        { id: 6, number: 3, gender: 'akhwat', chairman_name: "NAVA AISILA HASNA", chairman_class: "XI B", votes: 0 }
                    ];
                }
                
                // Set semua votes ke 0
                candidates.forEach(candidate => {
                    candidate.votes = 0;
                });
                
                localStorage.setItem('candidates', JSON.stringify(candidates));
                
                // Close modal
                closeResetModal();
                
                // Tampilkan notifikasi sukses
                showNotification('âœ… Semua data voting berhasil direset!', 'success');
                
                // Refresh data
                setTimeout(() => {
                    loadVotingData();
                }, 500);
                
            } catch (error) {
                console.error("âŒ Error resetting votes:", error);
                showNotification('âŒ Gagal mereset data voting', 'error');
            }
        }
        
        // ============================================
        // 7. EXPORT DATA FUNCTIONS
        // ============================================
        function exportData(format) {
            try {
                const candidates = JSON.parse(localStorage.getItem('candidates') || '[]');
                const votes = JSON.parse(localStorage.getItem('admin_votes') || '[]');
                
                let data, filename, mimeType;
                
                switch(format) {
                    case 'json':
                        data = JSON.stringify({
                            candidates: candidates,
                            votes: votes,
                            export_date: new Date().toISOString(),
                            total_votes: votes.length
                        }, null, 2);
                        filename = `vote_data_${new Date().toISOString().split('T')[0]}.json`;
                        mimeType = 'application/json';
                        break;
                        
                    case 'csv':
                        // Header CSV
                        let csv = 'No,Nama,Kelas,Gender,Jumlah Suara\n';
                        candidates.forEach(candidate => {
                            csv += `${candidate.number},"${candidate.chairman_name}",${candidate.chairman_class},${candidate.gender},${candidate.votes}\n`;
                        });
                        data = csv;
                        filename = `vote_data_${new Date().toISOString().split('T')[0]}.csv`;
                        mimeType = 'text/csv';
                        break;
                        
                    case 'pdf':
                        // Untuk PDF, kita buka window dengan data
                        const pdfContent = `
                            <html>
                            <head><title>Data Voting OSSIP 2026</title></head>
                            <body>
                                <h1>Data Voting OSSIP 2026</h1>
                                <p>Ekspor pada: ${new Date().toLocaleString('id-ID')}</p>
                                <h2>Hasil Voting:</h2>
                                <table border="1" cellpadding="5" style="border-collapse: collapse;">
                                    <tr>
                                        <th>No</th><th>Nama</th><th>Kelas</th><th>Gender</th><th>Suara</th>
                                    </tr>
                                    ${candidates.map(c => `
                                        <tr>
                                            <td>${c.number}</td>
                                            <td>${c.chairman_name}</td>
                                            <td>${c.chairman_class}</td>
                                            <td>${c.gender}</td>
                                            <td>${c.votes}</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </body>
                            </html>
                        `;
                        
                        const win = window.open('', '_blank');
                        win.document.write(pdfContent);
                        win.document.close();
                        win.print();
                        return;
                }
                
                // Download file
                const blob = new Blob([data], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification(`âœ… Data berhasil diexport sebagai ${format.toUpperCase()}`, 'success');
                closeExportModal();
                
            } catch (error) {
                console.error("âŒ Export error:", error);
                showNotification('âŒ Gagal mengexport data', 'error');
            }
        }
        
        // ============================================
        // 8. REAL-TIME POLLING
        // ============================================
        function startRealTimePolling() {
            // Polling setiap 3 detik
            pollingInterval = setInterval(() => {
                const currentTimestamp = parseInt(localStorage.getItem('last_vote_timestamp') || '0');
                
                if (currentTimestamp > lastVoteTimestamp) {
                    console.log("ðŸ”„ New vote detected, updating...");
                    lastVoteTimestamp = currentTimestamp;
                    loadVotingData();
                    showNotification('ðŸŽ‰ Vote baru diterima!', 'info');
                }
            }, 3000);
        }
        
        // ============================================
        // 9. MODAL CONTROLS
        // ============================================
        function openResetModal() {
            document.getElementById('resetModal').style.display = 'flex';
            document.getElementById('adminPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('adminPassword').style.borderColor = '#ddd';
        }
        
        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }
        
        function openExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }
        
        // ============================================
        // 10. NOTIFICATION SYSTEM
        // ============================================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'vote-notification';
            
            let icon = 'fa-info-circle';
            let color = '#3498db';
            
            switch(type) {
                case 'success': icon = 'fa-check-circle'; color = '#27ae60'; break;
                case 'error': icon = 'fa-exclamation-circle'; color = '#e74c3c'; break;
                case 'warning': icon = 'fa-exclamation-triangle'; color = '#f39c12'; break;
                case 'info': icon = 'fa-info-circle'; color = '#3498db'; break;
            }
            
            notification.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="background:${color};color:white;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div>
                        <div>${message}</div>
                        <div style="font-size:11px;color:#666;">${new Date().toLocaleTimeString('id-ID')}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animasi masuk
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 10);
            
            // Hapus setelah 5 detik
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }
        
        // ============================================
        // 11. EVENT LISTENERS
        // ============================================
        document.getElementById('refreshBtn').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memperbarui...';
            loadVotingData();
            
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
            }, 1000);
        });
        
        document.getElementById('resetBtn').addEventListener('click', openResetModal);
        document.getElementById('exportBtn').addEventListener('click', openExportModal);
        
        document.getElementById('confirmReset').addEventListener('click', resetAllVotes);
        document.getElementById('cancelReset').addEventListener('click', closeResetModal);
        document.querySelector('.close-modal').addEventListener('click', closeResetModal);
        
        document.getElementById('exportJSON').addEventListener('click', () => exportData('json'));
        document.getElementById('exportCSV').addEventListener('click', () => exportData('csv'));
        document.getElementById('exportPDF').addEventListener('click', () => exportData('pdf'));
        document.querySelector('.close-export-modal').addEventListener('click', closeExportModal);
        
        // Listen untuk real-time vote dari halaman voting
        window.addEventListener('newVoteSubmitted', function(event) {
            console.log('ðŸŽ¯ New vote received via event:', event.detail);
            loadVotingData();
        });
        
        // Password input enter key
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                resetAllVotes();
            }
        });
        
        // Close modal ketika klik di luar modal
        window.addEventListener('click', function(event) {
            const resetModal = document.getElementById('resetModal');
            const exportModal = document.getElementById('exportModal');
            
            if (event.target === resetModal) {
                closeResetModal();
            }   
            if (event.target === exportModal) {
                closeExportModal();
            }
        });
        
        // ============================================
        // 12. INITIALIZE
        // ============================================
        initializeDashboard();
        
        // Cleanup saat halaman ditutup
        window.addEventListener('beforeunload', function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    });

    // ============================================
// ADMIN DASHBOARD SYNC RECEIVER
// ============================================

class AdminSyncReceiver {
    constructor() {
        this.lastUpdate = localStorage.getItem('last_admin_update') || '0';
        this.syncCheckInterval = null;
        this.isProcessing = false;
    }
    
    // ============================================
    // 1. INITIALIZE SYNC RECEIVER
    // ============================================
    initialize() {
        console.log("ðŸ“¡ Admin sync receiver initializing...");
        
        // Start checking for updates
        this.startSyncCheck();
        
        // Listen for BroadcastChannel messages
        this.setupBroadcastListener();
        
        // Listen for localStorage changes
        this.setupStorageListener();
        
        // Initial data load
        this.checkForUpdates();
    }
    
    // ============================================
    // 2. START SYNC CHECK (EVERY 5 SECONDS)
    // ============================================
    startSyncCheck() {
        console.log("ðŸ”„ Starting sync check (5 seconds)");
        
        this.syncCheckInterval = setInterval(() => {
            this.checkForUpdates();
        }, 5000); // Check every 5 seconds
    }
    
    // ============================================
    // 3. CHECK FOR UPDATES FROM VOTING DEVICES
    // ============================================
    async checkForUpdates() {
        if (this.isProcessing) return;
        
        this.isProcessing = true;
        
        try {
            // Check for sync triggers
            const hasUpdate = await this.checkSyncTriggers();
            
            if (hasUpdate) {
                console.log("ðŸ”„ Update detected, loading data...");
                await this.loadSyncedData();
                this.showUpdateNotification();
            }
            
        } catch (error) {
            console.error("âŒ Update check failed:", error);
        } finally {
            this.isProcessing = false;
        }
    }
    
    // ============================================
    // 4. CHECK SYNC TRIGGERS
    // ============================================
    async checkSyncTriggers() {
        // Check admin update trigger
        const adminTrigger = localStorage.getItem('admin_update_trigger');
        if (adminTrigger) {
            const trigger = JSON.parse(adminTrigger);
            const triggerTime = parseInt(trigger.timestamp);
            
            if (triggerTime > parseInt(this.lastUpdate)) {
                console.log("ðŸŽ¯ Admin update trigger found:", trigger);
                this.lastUpdate = triggerTime.toString();
                localStorage.setItem('last_admin_update', this.lastUpdate);
                localStorage.removeItem('admin_update_trigger');
                return true;
            }
        }
        
        // Check sync data from voting devices
        const syncData = localStorage.getItem('admin_sync_data');
        if (syncData) {
            const data = JSON.parse(syncData);
            const dataTime = new Date(data.timestamp).getTime();
            
            if (dataTime > parseInt(this.lastUpdate)) {
                console.log("ðŸ“Š Sync data found from device:", data.device_id);
                this.lastUpdate = dataTime.toString();
                return true;
            }
        }
        
        // Check IndexedDB for updates
        const indexedDBUpdate = await this.checkIndexedDB();
        if (indexedDBUpdate) {
            return true;
        }
        
        return false;
    }
    
    // ============================================
    // 5. LOAD SYNCED DATA
    // ============================================
    async loadSyncedData() {
        try {
            // Load from multiple sources
            const allData = await this.loadAllDataSources();
            
            // Merge data
            await this.mergeData(allData);
            
            // Refresh dashboard
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            }
            
            console.log("âœ… Synced data loaded and merged");
            
        } catch (error) {
            console.error("âŒ Failed to load synced data:", error);
        }
    }
    
    // ============================================
    // 6. LOAD ALL DATA SOURCES
    // ============================================
    async loadAllDataSources() {
        const dataSources = {
            localStorage: {},
            indexedDB: {},
            syncStorage: {}
        };
        
        // Source 1: localStorage
        dataSources.localStorage = {
            votes: JSON.parse(localStorage.getItem('votes') || '[]'),
            teacher_votes: JSON.parse(localStorage.getItem('teacher_votes') || '[]'),
            candidates: JSON.parse(localStorage.getItem('candidates') || '[]'),
            voters: JSON.parse(localStorage.getItem('voters') || '[]'),
            teachers: JSON.parse(localStorage.getItem('teachers') || '[]')
        };
        
        // Source 2: Sync storage
        const syncData = localStorage.getItem('admin_sync_data');
        if (syncData) {
            dataSources.syncStorage = JSON.parse(syncData);
        }
        
        // Source 3: IndexedDB
        dataSources.indexedDB = await this.loadFromIndexedDB();
        
        return dataSources;
    }
    
    // ============================================
    // 7. MERGE DATA FROM ALL SOURCES
    // ============================================
    async mergeData(dataSources) {
        console.log("ðŸ”„ Merging data from multiple sources...");
        
        // Merge votes (remove duplicates)
        const allVotes = [
            ...dataSources.localStorage.votes,
            ...(dataSources.syncStorage.votes || []),
            ...(dataSources.indexedDB.votes || [])
        ];
        
        const uniqueVotes = this.removeDuplicates(allVotes, 'timestamp', 'voter_id');
        localStorage.setItem('votes', JSON.stringify(uniqueVotes));
        
        // Merge teacher votes
        const allTeacherVotes = [
            ...dataSources.localStorage.teacher_votes,
            ...(dataSources.syncStorage.teacher_votes || []),
            ...(dataSources.indexedDB.teacher_votes || [])
        ];
        
        const uniqueTeacherVotes = this.removeDuplicates(allTeacherVotes, 'timestamp', 'username');
        localStorage.setItem('teacher_votes', JSON.stringify(uniqueTeacherVotes));
        
        // Merge candidates (update vote counts)
        const allCandidates = this.mergeCandidates(
            dataSources.localStorage.candidates,
            dataSources.syncStorage.candidates,
            dataSources.indexedDB.candidates
        );
        
        localStorage.setItem('candidates', JSON.stringify(allCandidates));
        
        console.log(`âœ… Merged: ${uniqueVotes.length} votes, ${uniqueTeacherVotes.length} teacher votes`);
    }
    
    // ============================================
    // 8. REMOVE DUPLICATES
    // ============================================
    removeDuplicates(array, timestampKey, idKey) {
        const seen = new Map();
        const result = [];
        
        array.forEach(item => {
            const key = `${item[timestampKey]}_${item[idKey]}`;
            if (!seen.has(key)) {
                seen.set(key, true);
                result.push(item);
            }
        });
        
        return result;
    }
    
    // ============================================
    // 9. MERGE CANDIDATES
    // ============================================
    mergeCandidates(...candidateArrays) {
        const candidateMap = new Map();
        
        candidateArrays.forEach(array => {
            array.forEach(candidate => {
                if (candidateMap.has(candidate.id)) {
                    const existing = candidateMap.get(candidate.id);
                    // Use highest vote count
                    if ((candidate.votes || 0) > (existing.votes || 0)) {
                        candidateMap.set(candidate.id, candidate);
                    }
                } else {
                    candidateMap.set(candidate.id, candidate);
                }
            });
        });
        
        return Array.from(candidateMap.values());
    }
    
    // ============================================
    // 10. LOAD FROM INDEXEDDB
    // ============================================
    async loadFromIndexedDB() {
        if (!window.indexedDB) return {};
        
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('VoteSyncDB', 1);
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['sync_data'], 'readonly');
                const store = transaction.objectStore('sync_data');
                const getAllRequest = store.getAll();
                
                getAllRequest.onsuccess = function() {
                    const allData = getAllRequest.result;
                    
                    // Combine all sync data
                    const combined = {
                        votes: [],
                        teacher_votes: [],
                        candidates: []
                    };
                    
                    allData.forEach(data => {
                        if (data.votes) combined.votes.push(...data.votes);
                        if (data.teacher_votes) combined.teacher_votes.push(...data.teacher_votes);
                        if (data.candidates) combined.candidates.push(...data.candidates);
                    });
                    
                    resolve(combined);
                };
                
                getAllRequest.onerror = function(error) {
                    console.error("âŒ IndexedDB get error:", error);
                    resolve({});
                };
            };
            
            request.onerror = function(error) {
                console.error("âŒ IndexedDB open error:", error);
                resolve({});
            };
        });
    }
    
    // ============================================
    // 11. CHECK INDEXEDDB FOR UPDATES
    // ============================================
    async checkIndexedDB() {
        if (!window.indexedDB) return false;
        
        try {
            const data = await this.loadFromIndexedDB();
            return data.votes.length > 0 || data.teacher_votes.length > 0;
        } catch (error) {
            return false;
        }
    }
    
    // ============================================
    // 12. SETUP BROADCAST LISTENER
    // ============================================
    setupBroadcastListener() {
        if ('BroadcastChannel' in window) {
            const channel = new BroadcastChannel('vote_sync_channel');
            
            channel.onmessage = (event) => {
                if (event.data.type === 'sync_data') {
                    console.log("ðŸ“¡ Received broadcast sync data");
                    this.processIncomingData(event.data.data);
                }
            };
        }
    }
    
    // ============================================
    // 13. SETUP STORAGE LISTENER
    // ============================================
    setupStorageListener() {
        window.addEventListener('storage', (event) => {
            if (event.key === 'cross_tab_sync') {
                try {
                    const data = JSON.parse(event.newValue);
                    if (data.type === 'sync_update') {
                        console.log("ðŸ“¡ Received storage sync event");
                        this.checkForUpdates();
                    }
                } catch (error) {
                    // Ignore parse errors
                }
            }
        });
    }
    
    // ============================================
    // 14. PROCESS INCOMING DATA
    // ============================================
    processIncomingData(data) {
        // Save to localStorage
        localStorage.setItem('admin_sync_data', JSON.stringify(data));
        
        // Update last update timestamp
        this.lastUpdate = new Date(data.timestamp).getTime().toString();
        localStorage.setItem('last_admin_update', this.lastUpdate);
        
        // Trigger data load
        this.checkForUpdates();
    }
    
    // ============================================
    // 15. SHOW UPDATE NOTIFICATION
    // ============================================
    showUpdateNotification() {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        `;
        
        notification.innerHTML = `
            <i class="fas fa-bell"></i>
            <div>
                <strong>Data Terbaru Diterima!</strong>
                <div style="font-size:12px;opacity:0.9;">Dari perangkat voting</div>
            </div>
            <i class="fas fa-times" style="margin-left:10px;font-size:12px;"></i>
        `;
        
        // Close button
        notification.querySelector('.fa-times').addEventListener('click', (e) => {
            e.stopPropagation();
            notification.remove();
        });
        
        // Click to refresh
        notification.addEventListener('click', () => {
            if (typeof loadDashboardData === 'function') {
                loadDashboardData();
                notification.remove();
            }
        });
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // ============================================
    // 16. CLEANUP
    // ============================================
    cleanup() {
        if (this.syncCheckInterval) {
            clearInterval(this.syncCheckInterval);
        }
    }
}

// ============================================
// INITIALIZE ADMIN SYNC RECEIVER
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // Initialize after dashboard is loaded
    setTimeout(() => {
        window.adminSyncReceiver = new AdminSyncReceiver();
        window.adminSyncReceiver.initialize();
        
        console.log("âœ… Admin sync receiver ready");
    }, 2000);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (window.adminSyncReceiver) {
        window.adminSyncReceiver.cleanup();
    }
});
    </script>
</body>
</html>